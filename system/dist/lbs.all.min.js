var lbs=lbs||{debug:!1,verboseLevel:null,limeDataConnection:window.external,limeVersion:{},hasLimeConnection:!0,activeClass:"",activeDatabase:"",activeServer:"",activeInspector:"",wrapperType:"actionpad",apps:{},error:!1,vm:{},loading:{},config:{dataSources:[{type:"activeInspector",source:""},{type:"localization",source:""}],resources:{scripts:[],styles:[],libs:["json2xml.js","moment.min.js"]},autorefresh:!1},setup:function(){var e=moment();this.setSystemOperationParameters(),this.debug=lbs.externalConfig.debug,lbs.SetTouchEnabled(!1),window.console.log=lbs.log.log,this.setVerboseLevel(),this.log.setup(lbs.debug),this.setActionPadEnvironment(),this.setupLoader(),this.processConfiguration(),this.setActiveDBandServer(),this.setSkin(),moment.lang(lbs.common.executeVba("Localize.GetLanguage")),this.vm=lbs.loader.loadDataSources(this.vm,this.config.dataSources,!1),this.log.watch.setup(),this.loader.loadView("system/view/{0}".format(lbs.wrapperType),$("#wrapper")),this.loader.loadView(lbs.activeClass,$("#content")),this.apploader.buildCarousel(),this.apploader.identifyApps(),this.loader.loadResources();var o=moment();this.apploader.buildApps(),this.applyContentBindings(),this.apploader.initializeApps();var t=moment();this.log.vm.enableConsole(),this.ExecuteOnloadEvents(),this.SetJqEvents(),this.checkForUpdates(),lbs.loading.showLoader(!1),lbs.bakery.loader(),lbs.log.watch.sh();var a=moment();lbs.log.info("Total load time: "+a.diff(e,"milliseconds")+"ms"),lbs.log.info("App load time: "+t.diff(o,"milliseconds")+"ms")},processConfiguration:function(){this.config=lbs.loader.loadExternalConfig(this.config,this.externalConfig.config,this.activeClass)},setupLoader:function(){this.loader.loadView("system/view/loader",$("#loadingIndicator")),lbs.loading.showLoader=ko.observable(!0),lbs.loading=ko.mapping.fromJS(lbs.loading),ko.applyBindings(lbs.loading,$("#loadingIndicator").get(0))},setSystemOperationParameters:function(){$.ajaxSetup({async:!1}),this.vm=new lbs.vmFactory,this.hasLimeConnection="undefined"!=typeof lbs.limeDataConnection.Application,this.limeVersion=lbs.hasLimeConnection?lbs.common.parseVersion(lbs.limeDataConnection.Version):lbs.common.parseVersion("0.0.0")},setDebug:function(e){lbs.debug=e},setVerboseLevel:function(){if(lbs.externalConfig.verboseLevel)switch(lbs.externalConfig.verboseLevel){case"debug":lbs.verboseLevel=lbs.log.verboseLevelEnum.debug;break;case"info":lbs.verboseLevel=lbs.log.verboseLevelEnum.info;break;case"warn":lbs.verboseLevel=lbs.log.verboseLevelEnum.warn;break;case"error":lbs.verboseLevel=lbs.log.verboseLevelEnum.error;break;default:lbs.verboseLevel=lbs.log.verboseLevelEnum.warn}else lbs.verboseLevel=lbs.log.verboseLevelEnum.warn},setActionPadEnvironment:function(){var e=null,o=null,t=null;if(lbs.hasLimeConnection)try{e=lbs.common.getURLParameter("apowner"),null!==e?"inspector"==e?(t=lbs.common.getURLParameter("apownerid"),t&&(o=lbs.limeDataConnection.Inspectors.Lookup(t))):(e="application")&&(o=null):o=lbs.limeDataConnection.ActiveInspector,o?(lbs.activeInspector=o,lbs.activeClass=o["class"].Name):(lbs.activeInspector=null,lbs.activeClass="index")}catch(a){lbs.log.warn("Could not determine inspector class, assuming index",a),lbs.activeClass="index"}null!==lbs.common.getURLParameter("ap")&&(this.activeClass=lbs.common.getURLParameter("ap")),null!==lbs.common.getURLParameter("sv")&&(this.activeClass="system/view/{0}".format(lbs.common.getURLParameter("sv")));try{if(wrapperType=lbs.common.getURLParameter("type"),null!==wrapperType)switch(wrapperType){case"tab":lbs.wrapperType="wrapperTab";break;case"inline":lbs.wrapperType="wrapperInline";break;default:lbs.wrapperType="wrapperActionpad"}else lbs.wrapperType="wrapperActionpad"}catch(a){lbs.log.error("Could not determine wrapper type",a)}lbs.log.info("Using wrapper type: "+lbs.wrapperType),lbs.log.info("Using view: "+lbs.activeClass)},setActiveDBandServer:function(){try{lbs.activeServer=lbs.limeDataConnection.Database.ActiveServerName,lbs.activeDatabase=lbs.limeDataConnection.Database.Name,lbs.log.info("Active Server, Database: "+lbs.activeServer+", "+lbs.activeDatabase)}catch(e){lbs.log.warn("Could not set active server and database")}},setSkin:function(){try{var e=lbs.hasLimeConnection?lbs.limeDataConnection.application.Theme:1;1==e?(lbs.log.info("Silver skin is used"),$("body").addClass("silver")):2==e&&(lbs.log.info("Skin: I'm Britney bitch!"),$("body").addClass("britney"))}catch(o){lbs.log.warn("Could not set the skin")}},SetJqEvents:function(){},GlobalEventHandler:{OnKeydown:function(e,o){if(o.ctrlKey&&o.shiftKey&&82==o.which)location.reload();else if(o.ctrlKey&&o.shiftKey&&87==o.which)lbs.log.watch.show("WATCH");else{if(!o.ctrlKey||!o.shiftKey||76!=o.which)return!0;lbs.log.watch.show("LOG")}}},SetTouchEnabled:function(e){$("html").attr("oncontextmenu","return {0}".format(e?"true":"false")),$("html").toggleClass("notouch",!e)},ExecuteOnloadEvents:function(){$(".header-icon").each(function(){$(this).addClass("header-icon-container"),$(this).css("background-image","url('resources/"+lbs.activeClass+".png')"),$(this).append('<img src="resources/'+lbs.activeClass+'.png" class="header-icon-invis" />')}),$("body").on("click",function(e){"popover"!==$(e.target).data("toggle")&&0===$(e.target).parents(".popover.in").length&&$('[data-toggle="popover"]').popover("hide")}),$(".carousel").carousel().on("slide.bs.carousel",function(e){var o=$(e.relatedTarget).height();$(this).find(".active.item").parent().animate({height:Math.max(o,$(e.currentTarget).height())},500)})},applyContentBindings:function(){ko.punches.interpolationMarkup.enable(),ko.punches.attributeInterpolationMarkup.enable(),ko.punches.textFilter.enableForBinding("text");try{ko.applyBindings(lbs.vm,$("#content").get(0))}catch(e){lbs.log.warn("Binding of data ActionPad failed! \n Displaying mapping attributes",e)}try{ko.applyBindings(lbs.vm,$("body").get(0))}catch(e){lbs.log.warn("Binding of body bindings failed!",e)}},checkForUpdates:function(){if(lbs.debug&&lbs.hasLimeConnection){var e="http://api.lime-bootstrap.com/";$.each(lbs.apps,function(o,t){try{var a=t.name,n=$.parseJSON(lbs.loader.loadFromExternalWebService(e+"apps/"+a+"/"));if(!n)return void lbs.log.warn("Failed to check remote version of app: '"+a+"'");if(n.error)return void lbs.log.warn("Failed to check remote version of app: '"+a+"'. Reason: "+n.error);var r=n.info.versions,s=lbs.loader.loadLocalFileToString("apps/"+a+"/app.json");if(""===s)return void lbs.log.warn("Failed to check local version of app: "+a,d);var l=$.parseJSON(s).versions,i=_.max(r,function(e){return e.version}).version,c=_.max(l,function(e){return e.version}).version;parseFloat(c)<parseFloat(i)?(lbs.log.warn("App "+a+" has an available update. Installed version: "+c+", Available version: "+i),lbs.log.vm.addAppUpdate({appName:a,remoteVersion:i,localVersion:c})):lbs.log.info("App "+a+" is up to date (version: "+c+")")}catch(d){lbs.log.warn("Failed to check version of app: "+a,d)}});try{var o=lbs.loader.loadFromExternalWebService(e+"version");if(!o)return void lbs.log.warn("Failed to check remote version of LBS! ");var t=$.parseJSON(o),a=t.versions.sort(function(e,o){return lbs.common.compareVersions(e.version.toString(),o.version.toString())}),n=$.parseJSON(lbs.loader.loadLocalFileToString("system/version.json")),r=a[0].version;a=n.versions.sort(function(e,o){return lbs.common.compareVersions(e.version.toString(),o.version.toString())});var s=a[0].version;r.toString().split(".")[1]>s.toString().split(".")[1]?(lbs.log.vm.showUpgrade(!0),lbs.log.vm.showLBSVersion(!0),lbs.log.vm.remoteVersion(" v{0}-> v{1}".format(s,r)),lbs.log.warn("Your LIME Bootstrap is out of date! v{0}->v{1}".format(s,r))):lbs.log.info("LBS version: v{0}".format(s))}catch(l){lbs.log.warn("Failed to check version of LBS! ",l)}}}};lbs.vmFactory=function(){},$(document).ready(function(){window.lbs=lbs,lbs.setup()}),lbs.log={vm:null,verboseLevelEnum:{debug:3,info:2,warn:1,error:0},setup:function(e){lbs.loader.loadView("system/view/debug",$("#debug")),this.vm=new lbs.log.vmFactory(e),ko.applyBindings(this.vm,$("#debug").get(0))},logToDom:function(e,o){lbs.log.vm&&lbs.log.vm.addEntry(e.toUpperCase(),o)},logToConsole:{debug:function(e){try{console.debug(e)}catch(o){}},info:function(e){try{console.info(e)}catch(o){}},warn:function(e){try{console.warn(e)}catch(o){}},error:function(e){lbs.error=!0,lbs.log.vm.errorFound(!0),lbs.SetTouchEnabled(!0);try{console.error(e)}catch(o){}}},log:function(){lbs.log.logToConsole.debug(arguments);for(var e=0;e<arguments.length;e++)Array.isArray(arguments[e])?arguments[e]=ko.toJSON(arguments[e],null,0):"object"==typeof arguments[e]?arguments[e]=ko.toJSON(arguments[e],void 0,4):arguments[e]=arguments[e].toString(),lbs.log.logToDom("LOG",lbs.common.nl2brIndent(arguments[e]))},debug:function(e){lbs.verboseLevel>=lbs.log.verboseLevelEnum.debug&&(lbs.log.logToDom("DEBUG",lbs.common.nl2brIndent(e)),lbs.log.logToConsole.debug(e))},info:function(e){lbs.verboseLevel>=lbs.log.verboseLevelEnum.info&&(lbs.log.logToDom("INFO",lbs.common.nl2brIndent(e)),lbs.log.logToConsole.info(e))},warn:function(e,o){lbs.verboseLevel>=lbs.log.verboseLevelEnum.warn&&(o&&lbs.log.exception(o,"WARN"),lbs.log.logToDom("WARN",lbs.common.nl2brIndent(e)),lbs.log.logToConsole.warn(e))},error:function(e,o){o&&lbs.log.exception(o),lbs.log.logToDom("ERROR",lbs.common.nl2brIndent(e)),lbs.log.logToConsole.error(e)},exception:function(e,o){lbs.verboseLevel>=lbs.log.verboseLevelEnum.error&&(lbs.log.logToDom("ERROR",lbs.common.nl2brIndent(e.toString())),lbs.log.logToConsole.error(e.toString()))},logToInfolog:function(e,o){try{"info"!==e&&"warning"!==e&&"error"!==e&&(e="info"),"object"==typeof o?o=JSON.stringify(o):"string"!=typeof o&&(o=o.toString()),lbs.common.executeVba("LBSHelper.logToInfolog,"+e+","+o.replace(/,/g,"!@!").replace(/'/g,"%&%"))}catch(t){lbs.common.executeVba("LBSHelper.logToInfolog,error,"+t.toString().replace(/,/g,"!@!").replace(/'/g,"%&%"))}}},lbs.log.vmFactory=function(e){var o=this;this.maxNbrOfItems=30,this.logItems=ko.observableArray([]),this.enabled=ko.observable(e),this.delayedLogItems=[],this.delayedLoggingEnabled=!0,this.showUpgrade=ko.observable(!1),this.appUpdates=ko.observableArray(),this.showLBSVersion=ko.observable(!1),this.remoteVersion=ko.observable(),this.errorFound=ko.observable(!1),this.addAppUpdate=function(e){o.showUpgrade(!0),o.appUpdates.push(e)},this.enableConsole=function(){this.delayedLoggingEnabled=!1,this.pushDelayedLogItems()},this.addEntry=function(e,o){switch(ico="icon-exclamation",rowclass="alert alert-info",e){case"DEBUG":ico="fa fa-cog",rowclass="alert alert-info";break;case"INFO":ico="fa fa-info-circle",rowclass="alert alert-info";break;case"WARN":ico="fa fa-warning",rowclass="alert alert-warning";break;case"LOG":ico="fa fa-paw",rowclass="alert alert-success";break;case"ERROR":ico="fa fa-times-circle",rowclass="alert alert-danger",this.enabled(!0)}this.delayedLoggingEnabled?this.delayedLogItems.push({level:e,text:o,icon:ico,liclass:rowclass}):(this.logItems().length>=this.maxNbrOfItems&&this.logItems.shift(),this.logItems.push({level:e,text:o,icon:ico,liclass:rowclass}))},this.pushDelayedLogItems=function(){var e;for(e in this.delayedLogItems)this.logItems.push(this.delayedLogItems[e])}},lbs.log.watch={show:function(e){var o=new lbs.log.watch.vmFactory;""!==e&&(o.initState=e);showModalDialog("lbs.html?sv=watch&&type=tab",o,"status:false;dialogWidth:900px;dialogHeight:820px;resizable:Yes")},setup:function(){if("system/view/watch"==lbs.activeClass&&window.dialogArguments){lbs.log.vm.enabled(!1),lbs.SetTouchEnabled(!0);var e=window.dialogArguments,o=new lbs.log.watch.vmFactory;o.vms=e.vms,o.logItems=e.logItems,o.initState=e.initState,o.dom=e.dom,vm=lbs.common.mergeOptions(lbs.vm,o||{},!0),o.selectState(o.initState),o.selectVm(o.vms[0]);var t={70:!1,27:!1,17:!1};$("body").keydown(function(e){e.keyCode in t&&(t[e.keyCode]=!0,t[70]&&t[17]&&($("#searchValue").focus(),t[70]=!1,t[17]=!1),t[27]&&(window.close(),t[27]=!1))}).keyup(function(e){e.keyCode in t&&(t[e.keyCode]=!1)})}},sh:function(){$("pre code").each(function(e,o){hljs.highlightBlock(o)})},vmFactory:function(){var e=this;e.selectedVm=ko.observable({name:"",vm:{}}),e.vms=[],e.logItems=[],e.selectedState=ko.observable("LOG"),e.states=["LOG","WATCH","DOM"],e.initState="LOG",e.searchValue=ko.observable().extend({throttle:50}),e.logView=ko.observable("SHOW ALL"),e.logStatus=["LOG"],e.watchSelected=ko.observable(!1);var o="";e.counter=ko.observable(0),e.order=ko.observable(0),e.prettyVm=ko.computed(function(){return o="",e.searchValue(""),JSON.stringify(e.selectedVm().vm,null,2)}),$("body").keypress(function(o){13==o.which&&e.goToNext()}),e.select=function(){e.watchSelected(!0),$("#vmDataText").height($("#vmDataText").prop("scrollHeight"))},e.deSelect=function(){e.watchSelected(!1)},e.copyWatch=function(){window.clipboardData.setData("Text",$("#vmDataText").text())},e.searchValue.subscribe(function(t){var a=t.toLowerCase();if(e.order(0),a.length>1){var n=new RegExp(a,"g"),r=$("#vmData").html();""===o?o=r:$("#vmData").html(o),e.counter(e.replaceText($("#vmData"),n,a,t)),e.goToNext()}else e.counter(0),""==o?$("#vmData").html($("#vmData").html()):$("#vmData").html(o)}),e.goToNext=function(){if(e.order()<e.counter()&&e.counter()>0){var o="#"+e.order();if($(o).length>0){$("#watchContainer").animate({scrollTop:$(o).offset().top+$("#watchContainer").scrollTop()-200},200);var t="#"+(e.order()-1).toString(16);$(t).hasClass("highlight-grey")&&$(t).removeClass("highlight-grey").addClass("highlight-yellow"),$(o).addClass("highlight-grey"),e.order(e.order()+1)}}else e.order(0),e.goToNext()},e.replaceText=function(e,o,t,a){var n=0;return $(e).find("span").each(function(){if(($(this).hasClass("hljs-string")||$(this).hasClass("hljs-number")||$(this).hasClass("hljs-attribute"))&&$(this).text().toLowerCase().indexOf(t)>-1){var e=$(this).text().toLowerCase().replace(o,"<span id="+n+' class="highlight-yellow">'+a+"</span>");n+=1,$(this).html(e)}}),n},e.selectVm=function(o){e.selectedVm(o),lbs.log.watch.sh()},e.selectState=function(o){e.selectedState(o)},e.copyWatch=function(){window.clipboardData.setData("Text",$("#vmDataText").text())},e.selectedLogStatus=function(o){e.logView(o)};var t=$.map(lbs.apps,function(e,o){return{name:e.name,vm:e.vm||{}}});e.vms.push({name:"Actionpad",vm:lbs.vm}),e.vms=e.vms.concat(t),e.logItems=ko.toJS(lbs.log.vm.logItems),e.dom=$("#wrapper").get()[0].outerHTML}},lbs.loader={systemLibPath:"system/",scripts:[],styles:[],libs:[],pushResources:function(e,o){var t;"undefined"!=typeof e&&($.each(e.scripts,function(a){t="/"==o?lbs.loader.systemLibPath+"js/":o,lbs.loader.scripts.push(t+e.scripts[a])}),$.each(e.libs,function(o){t=lbs.loader.systemLibPath+"js/",lbs.loader.libs.push(t+e.libs[o])}),$.each(e.styles,function(a){t="/"==o?lbs.loader.systemLibPath+"css/":o,lbs.loader.styles.push(t+e.styles[a])}))},loadResources:function(){lbs.loader.scripts=lbs.loader.scripts.filter(this.uniqueFilter),lbs.loader.styles=lbs.loader.styles.filter(this.uniqueFilter),lbs.loader.libs=lbs.loader.libs.filter(this.uniqueFilter),lbs.log.debug("Scripts to load:"+lbs.loader.scripts),lbs.log.debug("Styles to load: "+lbs.loader.styles),lbs.log.debug("Libs to load: "+lbs.loader.libs),$.each(lbs.loader.libs,function(e){lbs.loader.loadScript(lbs.loader.libs[e])}),$.each(lbs.loader.scripts,function(e){lbs.loader.loadScript(lbs.loader.scripts[e])}),$.each(lbs.loader.styles,function(e){lbs.loader.loadStyle(lbs.loader.styles[e])})},loadScript:function(filename){try{$.getScript(filename).done(function(e,o){lbs.log.info('Script "'+filename+'" loaded successfully')}).fail(function(e,o,t){throw t}),retval=!0}catch(e){try{lbs.log.info('Script "'+filename+'" could not be loaded, using fallback loading through LWS');var s="";if(s=lbs.common.executeVba("LBSHelper.loadHTTPResource,"+filename),!s||""===s)throw new Error('Script "'+filename+'" returned empty');with(window)window.eval(s);lbs.log.info('Script "'+filename+'" loaded successfully'),retval=!0}catch(e2){lbs.log.error('Script "'+filename+'" could not be loaded though browser',e),lbs.log.error('Script "'+filename+'" could not be loaded through LWS',e2),retval=!1}}return retval},loadStyle:function(e){$("<link/>",{rel:"stylesheet",type:"text/css",href:e}).appendTo("head")},loadView:function(e,o){try{e+=".html",o.load(e,function(a,n,r){-1!=a.indexOf("<script")?(lbs.log.error('View "'+e+'" containes scripts, it is not allowed to be loaded'),o.html('<img src="'+lbs.loader.systemLibPath+'img/YouDidntSayTheMagicWord.gif" />')):"error"==n?lbs.log.error('View "'+e+'" could not be loaded',t):lbs.log.info('View "'+e+'" loaded successfully')})}catch(t){lbs.log.warn("Resource could not be found. If using Chrome or IE11, make sure --file-access-from-file is enabled"),lbs.log.warn('View "'+e+'" could not be loaded, using fallback loading through LWS');var a="";a=lbs.common.executeVba("LBSHelper.loadHTTPResource,"+e),a&&""!==a?(o.html(a),lbs.log.info('View "'+e+'" loaded successfully')):lbs.log.error('View "'+e+'" could not be loaded',t)}},loadDataSources:function(e,o,t){if(!lbs.hasLimeConnection)return lbs.log.warn("No connecton, datasources will not be loaded"),e;var a=function(e){return"relatedRecord"!=e.type},n=function(e){return"activeInspector"!=e.type},r=function(e){return"activeInspector"===e.type},s=function(e){return"relatedRecord"===e.type},l=o.filter(a).length!=o.length,i=o.filter(n).length!=o.length;if(l&&!i)o=o.filter(a),lbs.log.warn("Failed to load datasource 'RelatedRecord', activeInspector is not loaded");else if(l){var c=o.filter(r)[0];c.relatedRecords=o.filter(s),o=o.filter(a).filter(n),o.push(c)}return $.each(o,function(o,a){e=lbs.loader.loadDataSource(e,a,t)}),e},loadDataSource:function(e,o,t){var a={};lbs.log.debug("Loading data source: "+o.type+":"+o.source);var n=moment();try{switch(o.type){case"activeInspector":try{if(!lbs.activeInspector)return lbs.log.warn("No activeinspecor, datasource will not be loaded"),e;a=lbs.loader.controlsToJSON(lbs.activeInspector.Controls,o.alias),dataNode=a[Object.keys(a)[0]],o.hasOwnProperty("relatedRecords")&&$.each(o.relatedRecords,function(o,t){dataNode.hasOwnProperty(t.source)?(t["class"]=dataNode[t.source]["class"],t.idrecord=dataNode[t.source].value,vmToAdd=t.alias?e:dataNode,t.alias=t.alias?t.alias:t.source,lbs.loader.loadDataSource(vmToAdd,t,!0)):lbs.log.warn("Failed to load datasource 'RelatedRecord', field '{0}' does not exist".format(t.source))})}catch(r){lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source,r)}break;case"xml":var s=[];o.hasOwnProperty("PassInspectorParam")&&o.PassInspectorParam&&lbs.activeInspector&&s.push(lbs.activeInspector.ID),a=lbs.common.executeVba(o.source,s),null!==a?a=lbs.loader.xmlToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"record":var s=[];o.hasOwnProperty("PassInspectorParam")&&o.PassInspectorParam&&lbs.activeInspector&&s.push(lbs.activeInspector.ID),a=lbs.common.executeVba(o.source,s),null!==a?a=lbs.loader.recordToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"records":var s=[];o.hasOwnProperty("PassInspectorParam")&&o.PassInspectorParam&&lbs.activeInspector&&s.push(lbs.activeInspector.ID),a=lbs.common.executeVba(o.source,s),null!==a?a=lbs.loader.recordsToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"localization":var l=lbs.common.executeVba("Localize.getDictionaryKeys"),i=lbs.common.executeVba("Localize.getDictionary"),c={},d={};i&&l?(c=lbs.loader.dictionaryToJSON(l,i,"loc"),$.each(c.loc,function(e,o){keysplit=e.split("$$"),d[keysplit[0]]=d[keysplit[0]]||{},d[keysplit[0]][keysplit[1]]=o}),a.localize=d):lbs.log.warn("Localization dictionary could not be loaded");break;case"storedProcedure":a=lbs.common.executeVba("lbsHelper.loadXmlFromStoredProcedure, {0}".format(o.source)),null!==a?a=lbs.loader.xmlToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"HTTPGetXml":a=lbs.loader.loadFromExternalWebService(o.source),null!==a?a=lbs.loader.xmlToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"SOAPGetXml":a=lbs.common.executeVba("LBSHelper.loadFromSOAP,"+o.source.url+","+o.source.action+","+o.source.xml),null!==a?a=lbs.loader.xmlToJSON(a,o.alias):lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source);break;case"relatedRecord":try{var s=[];s.push(o["class"]),s.push(o.idrecord),o.hasOwnProperty("view")&&s.push(o.view),o.idrecord?(record=lbs.common.executeVba("lbsHelper.loadRelatedRecord",s),a=lbs.loader.recordToJSON(record,o.alias)):(a=lbs.loader.emptyAliasJSON(o.alias),lbs.log.debug("RelatedRecord load is canceled, idrecord is NULL: "+o.type+":"+o.source))}catch(r){lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source,r)}break;case"AsyncPost":var u=o.parameters||{};$.support.cors=!0,a={},a[o.alias]=$.ajax({contentType:"application/json",data:JSON.stringify(u),dataType:"json",type:"POST",url:o.url,crossDomain:!0});break;case"activeUser":var b=lbs.common.executeVba("lbsHelper.getActiveUser"),p=JSON.parse(b);a.ActiveUser=p.ActiveUser}e=lbs.common.mergeOptions(e,a||{},t)}catch(r){lbs.log.warn("Failed to load datasource: "+o.type+":"+o.source,r)}var g=moment();return lbs.log.warn("Time to load data source "+JSON.stringify(o)+" : "+g.diff(n,"milliseconds")+"ms"),e},loadExternalConfig:function(e,o,t){var a={};return o.hasOwnProperty(t)&&(a=o[t],a.hasOwnProperty("dataSources")&&(e.dataSources=a.dataSources),a.hasOwnProperty("autorefresh")&&(e.autorefresh=a.autorefresh)),e},loadFromExternalWebService:function(e){return lbs.common.executeVba("lbsHelper.loadFromREST,"+e)},loadLocalFileToString:function(e){return lbs.common.executeVba("lbsHelper.loadHTTPResource,"+e)},saveLocalFile:function(e,o){lbs.common.executeVba("lbsHelper.saveFile,"+e,[o])},uniqueFilter:function(e,o,t){return t.lastIndexOf(e)===o},dictionaryToJSON:function(e,o,t){for(var a,n,r={},s={},t=t?t:"dictionarySource",l=1;l<=o.count;l++)a=e(l),n=o.item(a),r[a]=n;return s[t]=r,s},recordsToJSON:function(e,o){var t={};if(e){var a=e.Class.Name,n=e.Count,o=o?o:a;t[o]={},t[o].records=[];for(var r=1;n>=r;r++){var s=lbs.loader.recordToJSON(e.Item(r),"r");t[o].records.push(s.r)}}return t},recordToJSON:function(e,o){var t={};if(e){var a,n=e.Fields.Count,r=e.Class.Name,o=o?o:r;t[o]={};for(var s=1;n>=s;s++)a=e.Fields(s).Name,t[o][a]={},t[o][a].text=e.Text(s),"unknown"!=typeof e.Value(s)&&(t[o][a].value=e.Value(s)),16==e.Fields(s).Type&&(t[o][a]["class"]=e.Fields(s).LinkedField.Class.Name),lbs.limeVersion.comparable>lbs.common.parseVersion("10.8").comparable&&19==e.Fields(s).Type&&(t[o][a].key=e.GetOptionKey(s))}return t},emptyAliasJSON:function(e){var o={};return o[e]={},o},controlsToJSON:function(e,o){var t,a=e.Count,n=e.Class.Name,r={},o=o?o:n;r[o]={};for(var s=1;a>=s;s++)t=e(s).Field.Name,r[o][t]={},r[o][t].text=e(s).Text,r[o][t].value=e(s).Value,16==e(s).Field.Type&&(r[o][t]["class"]=e(s).Field.LinkedField.Class.Name),lbs.limeVersion.comparable>lbs.common.parseVersion("10.8").comparable&&19==e(s).Field.Type&&(r[o][t].key=e(s).OptionKey);return r},xmlToJSON:function(e,o){var t={},o=o?o:"xmlSource";return t[o]=$.parseJSON(xml2json($.parseXML(e),"")),t},createUpdateTranslation:function(e,o,t,a){return lbs.common.executeVba("lbsHelper.CreateUpdateTranslation,",[e,o,t,a])}},lbs.apploader={appFactory:{},register:function(e,o){this.appFactory[e]=o,lbs.log.debug("App '{0}' has been succesfully registered".format(e))},identifyApps:function(){var path,raw,htmlNode,config,instanceConfig,binding,appName,instance,guid;return $("[data-app]").each(function(){try{try{eval("binding = "+$(this).attr("data-app")),appName=binding.app,instanceConfig=binding.config}catch(e1){throw e1.message="App definition invalid\n"+e1.message,e1}if(path="apps/"+appName+"/",htmlNode=$(this),guid=lbs.common.generateGuid(),!lbs.apploader.appFactory[appName]&&!lbs.loader.loadScript(path+"app.js"))throw new Error("Could not find app "+appName);instance=new lbs.apploader.appFactory[appName],instanceConfig&&("function"==typeof instance.config?instance.config=new instance.config(instanceConfig):instance.config=lbs.common.mergeOptions(instance.config,instanceConfig,!0)),lbs.loader.pushResources(instance.config.resources,path),lbs.apps[guid]=lbs.apps[guid]||{},lbs.apps[guid].name=appName,lbs.apps[guid].path=path,lbs.apps[guid].node=htmlNode,lbs.apps[guid].instance=instance}catch(e){lbs.log.warn("Could not load app",e)}}),this},buildCarousel:function(){var ol,li,binding,type,height;$("[data-carousel]").each(function(i1,d1){try{try{eval("binding = "+$(this).attr("data-carousel")),height=binding.height,type=binding.type,$(this).height(height),$(this).attr({id:"carousel-"+i1,"data-ride":"carousel","data-interval":"0"}),$(this).addClass("carousel slide lime-carousel"),$(this).children().each(function(){$(this).addClass("carousel-item")}),$(this).append("<ol></ol>"),ol=$(this).find("ol"),$(this).append(lbs.common.carouselRight,lbs.common.carouselLeft),$(this).find("a").attr("data-target","#carousel-"+i1),$(this).children(".carousel-item").wrapAll("<div class='carousel-inner'></div>"),ol.addClass("carousel-indicators"),$(this).children(".carousel-inner").children(".carousel-item").each(function(e,o){$(this).addClass("item"),ol.append("<li></li>"),li=ol.find("li").last(),0===e&&($(this).addClass("active"),li.addClass("active black")),li.attr({"data-slide-to":e,"data-target":"#carousel-"+i1}),li.addClass("black")})}catch(r){lbs.log.warn("Carousel definition is not valid",r)}}catch(e){lbs.log.warn("Could not load carousel",e)}})},buildApps:function(){$.each(lbs.apps,function(e,o){var t={};t.localize=lbs.vm.localize,t=lbs.loader.loadDataSources(t,o.instance.config.dataSources),lbs.apps[e].vm=t})},initializeApps:function(){var e,o,t;$.each(lbs.apps,function(a,n){o=n.name,e=n.path,t=n.node,config=n.config,vm=lbs.apps[a].vm,lbs.loader.loadView(e+"app",t);try{vm=n.instance.initialize(t,vm),lbs.apps[a].vm=vm}catch(r){lbs.apps[a].vm=vm,lbs.log.error("Could not intialize app: "+o,r)}try{ko.applyBindings(vm,t.get(0))}catch(r){lbs.log.warn(lbs.common.nl2br("Binding of data to view failed for app: "+o+"\n Displaying mapping attributes")),lbs.log.exception(r)}})}};var lbs=lbs||{};lbs.common={getErrorText:function(){var e=Math.floor(5*Math.random()+1);switch(e){case 1:return"Oh snap!";case 2:return"Oh no!";case 3:return"God damit!";case 4:return"Holy guacamole!";case 5:return"Arghhhh!"}},iconTemplate:"<i class='fa fa-fw {0}'></i>",escapeHtml:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},carouselRight:"<a class='right carousel-control' data-slide='next' role='button'><i class='fa fa-arrow-right'></i></a>",carouselLeft:"<a class='left carousel-control' data-slide='prev' role='button'><i class='fa fa-arrow-left'></i> </a>",createLimeLink:function(e,o){return"limecrm:"+e+"."+lbs.activeDatabase+"."+lbs.activeServer+"?"+o},getURLParameter:function(e){var o=decodeURI((RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1]);return"null"==o?null:o},executeVba:function(inString,params){try{if(!lbs.hasLimeConnection)return lbs.log.warn("No lime connection, will not exec VBA call:"+inString),null;var vbaline,inArgs=inString.split(",");if(params&&(inArgs=inArgs.concat(params)),inArgs.length>1){var args="";vbaline="lbs.limeDataConnection.Run('"+inArgs[0]+"', ";for(var i=1;i<inArgs.length;i++){for(inArgs[i]=String(inArgs[i]);" "===inArgs[i].charAt(0);)inArgs[i]=inArgs[i].substr(1);args+="'"+inArgs[i]+"'",i!=inArgs.length-1&&(args+=",")}return vbaline+=args+")",lbs.log.debug("Trying to execute VBA:"+vbaline),eval(vbaline)}return vbaline="lbs.limeDataConnection.Run('"+arguments[0]+"')",lbs.log.debug("Trying to execute VBA:"+vbaline),lbs.limeDataConnection.Run(arguments[0])}catch(e){return lbs.log.error("Failed to execute VBA:"+vbaline,e),null}},nl2br:function(e){return e.replace(/\n/g,"<br />")},nl2brIndent:function(e){return e.replace(/\n/g,"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")},brak2br:function(e){return e.replace(/{/g,"<br />").replace(/}/g,"<br />")},mergeOptions:function(e,o,t){return $.each(o,function(o,a){a&&(e[o]?e[o]instanceof Array&&a instanceof Array?e[o]=e[o].concat(a):t?(e[o]=a,lbs.log.debug("Key '{0}' in view model was overriden by dataload".format(o))):lbs.log.warn("Key '{0}' was not added to the view model. Key already exists".format(o)):e[o]=a)}),e},generateGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var o=16*Math.random()|0,t="x"==e?o:3&o|8;return t.toString(16)})},checkGroup:function(e,o){return o.map(function(e){return e.Name}).filter(function(o){return-1!=e.indexOf(o)}).length>0},parseVersion:function(e){var o=0,t=0,a=0,n=0,r=0,s=0,l=0;for(strVersion=e.split("."),l=0;l<strVersion.length&&3>l;l++)isNaN(strVersion[l])?lbs.log.error("Could not parse lime version number '{0}'".format(e)):0===l?(n=parseInt(strVersion[l]),o=1e4*n):1===l?(r=parseInt(strVersion[l]),t=1e3*r):2==l&&(s=parseInt(strVersion[l]),a=s);return{comparable:o+t+a,full:"{0}.{1}.{2}".format(n,r,s),major:n,nMinor:r,build:s}},compareVersions:function(e,o){for(var t=o.toString().split("."),a=e.toString().split("."),n=null,r=0;r<Math.min(t.length,a.length);r++){var s=parseInt(t[r]),l=parseInt(a[r]);if(s>l){n=1;break}if(l>s){n=-1;break}}return null==n&&t.length<a.length?n=-1:null==n&&t.length>a.length?n=1:null==n&&(n=0),n}},String.prototype.format||(String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(o,t){return"undefined"!=typeof e[t]?e[t]:o})}),ko.defaultBindingProvider=ko.bindingProvider.instance,ko.bindingProvider.instance={nodeHasBindings:ko.defaultBindingProvider.nodeHasBindings,getBindings:function(e,o){var t;try{t=ko.defaultBindingProvider.getBindings(e,o),this.checkValue(t,"text",e),this.checkValue(t,"value",e),t=this.processDependentBindings(t)}catch(a){lbs.log.error(a.message),t=this.getDummyBindings(e),t=this.processDependentBindings(t)}return t},checkValue:function(e,o,t){if(e&&e.hasOwnProperty(o)&&!e[o]&&""!==e[o]&&e[o]!==!1&&0!==e[o])throw new ReferenceError("Unable to set binding '{0}'.\nBindings value: {1}\nMessage: Property is undefined".format(o,$(t).attr("data-bind")))},processDependentBindings:function(e){return e?(e.hasOwnProperty("text")&&e.hasOwnProperty("icon")&&""!==e.text&&(e.textWithIcon={icon:e.icon,text:e.text},delete e.text,delete e.icon),e):void 0},getDummyBindings:function(e){var o,t={};return o=new RegExp("text:[^,}]*").exec($(e).attr("data-bind")),o&&(t.text="Binding: "+o[0].split(":")[1].trim()),o=new RegExp("value:[^,}]*").exec($(e).attr("data-bind")),o&&(t.value="Binding: "+o[0].split(":")[1].trim()),o=new RegExp("icon:[^,}]*").exec($(e).attr("data-bind")),o&&(t.icon=o[0].split(":")[1].trim().replace(/\'/g,"")),t}},ko.bindingHandlers.textWithIcon={update:function(e,o,t,a,n){var r=ko.unwrap(o()),s=lbs.common.iconTemplate.format(r.icon);$(e).html(s+"<span></span>"),ko.bindingHandlers.text.update($(e).find("span").get(0),function(){return r.text},t,a,n)}},ko.bindingHandlers.limeLink={init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba("shell,"+lbs.common.createLimeLink(ko.unwrap(o()["class"]),ko.unwrap(o().value)))}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.vba={init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba(o())}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.showOnMap={init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba("shell,https://www.google.com/maps?q="+encodeURIComponent(ko.unwrap(o()).replace(/\r?\n|\r/g," ")))}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.call={init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba("shell,tel:"+ko.unwrap(o()))}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.openURL={
init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba("shell,"+ko.unwrap(o()))}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.appInvoke={init:function(e,o,t,a,n){var r=function(){return lbs.hasLimeConnection===!0?function(){Invoker.invokeWebApplication(ko.unwrap(o()))}:function(){alert("AppInvoker is not avalible outside of lime")}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.vbaVisible={init:function(e,o,t,a,n){var r=lbs.common.executeVba(ko.unwrap(o()));r?($(e).show(),$(e).removeClass("hidden"),$(e).removeClass("remainHidden")):($(e).hide(),$(e).addClass("hidden"),$(e).addClass("remainHidden"))}},ko.bindingHandlers.visible={update:function(e,o){var t=ko.utils.unwrapObservable(o()),a=!("none"==e.style.display);t&&!a?(e.style.display="",$(e).removeClass("remainHidden")):!t&&a&&(e.style.display="none",$(e).addClass("remainHidden"))}},ko.bindingHandlers.email={init:function(e,o,t,a,n){var r=function(){return function(){lbs.common.executeVba("shell,mailto:"+ko.unwrap(o()))}};ko.bindingHandlers.click.init(e,r,t,a,n)}},ko.bindingHandlers.icon={init:function(e,o,t,a,n){var r=lbs.common.iconTemplate.format(ko.unwrap(o()));""!==$(e).text()&&$(e).text().substring(0,r.length)!=r&&($(e).prepend(r),e=$(e).get(0))}},ko.bindingHandlers.safeText={update:function(e,o,t){var a,n=ko.utils.unwrapObservable(o()),r=ko.utils.unwrapObservable(n.value),s=ko.utils.unwrapObservable(n.property),l=ko.utils.unwrapObservable(n["default"])||"";a=r?n.property?r[s]:r:l,ko.bindingHandlers.text.update(e,function(){return a})}},ko.bindingHandlers.href={update:function(e,o){ko.bindingHandlers.attr.update(e,function(){return{href:o()}})}},ko.bindingHandlers.src={update:function(e,o){ko.bindingHandlers.attr.update(e,function(){return{src:o()}})}},ko.bindingHandlers.instantValue={init:function(e,o,t){var a=function(){return ko.utils.extend(t(),{valueUpdate:"afterkeydown"})};a.get=function(e){return"valueupdate"===e?"afterkeydown":t.get(e)},a.has=function(e){return"valueupdate"===e||t.has(e)},ko.bindingHandlers.value.init(e,o,a)},update:ko.bindingHandlers.value.update},ko.bindingHandlers.toggle={init:function(e,o){var t=o();ko.applyBindingsToNode(e,{click:function(){t(!t())}})}},ko.bindingHandlers.stopBinding={init:function(){return{controlsDescendantBindings:!0}}},ko.virtualElements.allowedBindings.stopBinding=!0,ko.bindingHandlers.popover={init:function(e,o,t,a,n){var r,s,l,i,c,d;if("object"==typeof o()){switch(s="undefined"==typeof o().color?"blue":o().color,l="undefined"==typeof o().title?"Titel saknas":o().title,"undefined"==typeof o().placement?c="top":(c=o().placement,-1=="left,right,top,bottom".indexOf(o().placement)&&(c="top")),"undefined"==typeof o().trigger?d="hover":(d=o().trigger,-1=="hover,click".indexOf(o().trigger)&&(d="hover")),i="undefined"==typeof o().icon?"":'<i class="fa '+o().icon+'"></i>',o().type){case"error":s="red",i='<i class="fa fa-times"></i> ',l="Error";break;case"info":s="blue",i='<i class="fa fa-info-circle"></i> ',l="Information";break;case"warning":s="orange",i='<i class="fa fa-warning"></i> ',l="Warning";break;case"success":s="green",i='<i class="fa fa-check"></i> ',l="Success";break;case"custom":break;default:l="",r=o().text}l="<span>"+l+"</span>",r='<div><div class="message-header '+s+'">'+i+l+"</div>"+o().text+"</div>"}else r=o(),c="top",d="hover";$(e).attr({"data-toggle":"popover","data-container":"body","data-content":r,"data-placement":c}),$(e).popover({trigger:d,html:"true"})},update:function(e,o,t,a,n){var r,s,l,i,c,d;if("object"==typeof o()){switch(s="undefined"==typeof o().color?"blue":o().color,l="undefined"==typeof o().title?"Titel saknas":o().title,"undefined"==typeof o().placement?c="top":(c=o().placement,-1=="left,right,top,bottom".indexOf(o().placement)&&(c="top")),"undefined"==typeof o().trigger?d="hover":(d=o().trigger,-1=="hover,click".indexOf(o().trigger)&&(d="hover")),i="undefined"==typeof o().icon?"":'<i class="fa '+o().icon+'"></i>',o().type){case"error":s="red",i='<i class="fa fa-times"></i> ',l="Error";break;case"info":s="blue",i='<i class="fa fa-info-circle"></i> ',l="Information";break;case"warning":s="orange",i='<i class="fa fa-warning"></i> ',l="Warning";break;case"success":s="green",i='<i class="fa fa-check"></i> ',l="Success";break;case"custom":break;default:l="",r=o().text}r='<div><div class="message-header '+s+'">'+i+l+"</div>"+o().text+"</div>"}else r=o(),c="top",d="hover";$(e).attr({"data-toggle":"popover","data-container":"body","data-content":r,"data-placement":c})}},ko.bindingHandlers.tooltip={init:function(e,o,t,a,n){"object"==typeof o()?($(e).attr({"data-toggle":"tooltip","white-space":"nowrap","data-original-title":o().text,"data-placement":o().placement}),$(e).tooltip()):($(e).attr({"data-toggle":"tooltip","white-space":"pre-wrap","data-original-title":o(),"data-placement":"top"}),$(e).tooltip())},update:function(e,o,t,a,n){"object"==typeof o()?$(e).attr({"data-toggle":"tooltip","white-space":"pre-wrap","data-original-title":o().text,"data-placement":o().placement}):$(e).attr({"data-toggle":"tooltip","white-space":"pre-wrap","data-original-title":o(),"data-placement":"top"})}},ko.filters.number=function(e,o){return void 0===o&&(o=2),e=Number(Math.round(e+"e"+o)+"e-"+o),e.toLocaleString()},ko.filters.currency=function(e,o,t){var a,n=["$","£","¥","₱","₭","₦","₩","₮","฿","₹","₡","৳"];return"string"!=typeof e&&(e=e.toString()),void 0===o&&(o="kr"),void 0===t&&(t=" "),a=n.indexOf(o)>-1?o+" "+e.replace(/\B(?=(\d{3})+(?!\d))/g,t):e.replace(/\B(?=(\d{3})+(?!\d))/g,t)+" "+o},ko.filters.percent=function(e,o){return 100*e+"%"},ko.filters.fromNow=function(e,o){return e=e.slice(0,19),moment(e).fromNow(!0)},ko.bindingHandlers.rotate={update:function(e,o,t,a,n){var r=o();console.log(r),$(e).css({"-webkit-transform":"rotate("+r+"deg)","-moz-transform-transform":"rotate("+r+"deg)","-ms-transform-transform":"rotate("+r+"deg)","-o-transform:":"rotate("+r+"deg)","transform:":"rotate("+r+"deg)"})}},lbs.jotnar={winterEgg:function(){}},lbs.bakery={loader:function(){var e=decodeURI((RegExp("ap=(.+?)(&|$)").exec(location.search)||[,null])[1]);$(".expandable").each(function(){"0"===lbs.bakery.getCookie($(this).index()+"ul"+e)?($(this).find(".menu-header").prepend("<i class='fa fa-angle-down'> </i>"),$(this).removeClass("collapsed"),$(this).children("li").not(".remainHidden").show()):($(this).find(".menu-header").prepend("<i class='fa fa-angle-right'> </i>"),$(this).addClass("collapsed"),$(this).children("li").not(".menu-header").not(".divider").hide())}),$(".expandable").find(".menu-header").click(function(){var o=$(this).parent(),t=lbs.bakery.getCookie(o.index()+"ul"+e);t="0"===t?"1":"0",lbs.bakery.setCookie(o.index()+"ul"+e,t,"200"),lbs.bakery.hideshow(o,e)})},hideshow:function(e,o){var t=$(e);$(e).find("i").first().toggleClass("fa fa-angle-down"),$(e).find("i").first().toggleClass("fa fa-angle-right"),"0"===lbs.bakery.getCookie($(e).index()+"ul"+o)?(t.removeClass("collapsed"),t.children("li").not(".remainHidden").fadeIn(200)):(t.addClass("collapsed"),t.children("li").not(".menu-header").not(".divider").fadeOut(200))},setCookie:function(e,o,t){var a=decodeURI((RegExp("ap=(.+?)(&|$)").exec(location.search)||[,null])[1]);e=e+"-"+a;var n=new Date;n.setTime(n.getTime()+24*t*60*60*1e3);var r="expires="+n.toUTCString();"cookieid="+$(".expandable").attr("id");document.cookie=e+"="+o+"; "+r},getCookie:function(e){var o=decodeURI((RegExp("ap=(.+?)(&|$)").exec(location.search)||[,null])[1]);e=e+"-"+o;for(var t=e+"=",a=document.cookie.split(";"),n=0;n<a.length;n++){for(var r=a[n];" "==r.charAt(0);)r=r.substring(1);if(0==r.indexOf(t))return r.substring(t.length,r.length)}return""}};